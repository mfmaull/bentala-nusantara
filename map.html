<!DOCTYPE html>
<html lang="id" data-theme="light" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bentala Nusantara | GeoMaps</title>

  <!-- Tailwind (utility) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MapLibre -->
  <script src="https://unpkg.com/maplibre-gl@^5.7.3/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@^5.7.3/dist/maplibre-gl.css" rel="stylesheet" />

  <!-- Turf -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    /* Palette consistent with index.html: white - black - krem */
    :root{
      --bg: #ffffff;
      --fg: #0b0b0b;
      --krem: #f3ead7;
      --card: #fbf9f6;
      --border: #ece7df;
      --muted: #6f6f6f;
      --glass: rgba(11,11,11,0.04);
      --radius: 12px;
      --shadow-soft: 0 10px 30px rgba(11,11,11,0.06);
      --accent: #0b0b0b;
    }
    [data-theme="dark"]{
      --bg: #0b0b0b;
      --fg: #f5f5f5;
      --krem: #322b23;
      --card: #141414;
      --border: #222;
      --muted: #bdbdbd;
      --glass: rgba(255,255,255,0.03);
      --accent: #f5f5f5;
    }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    a{color:inherit}
    .container { max-width:1200px; margin:0 auto; padding-left:1rem; padding-right:1rem; }

    /* Header small top bar inside toolbox to match index */
    body { display:flex; height:100vh; overflow:hidden; }

    /* Toolbox / Sidebar */
    #toolbox{
      width:280px;
      min-width:220px;
      background:var(--card);
      border-right:1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:12px;
      transition: width .28s ease, transform .28s ease;
    }
    /* Make toolbox look glassy */
    #toolbox .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.45));
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow:0 8px 24px var(--glass);
    }
    [data-theme="dark"] #toolbox .glass {
      background: linear-gradient(180deg, rgba(11,11,11,0.8), rgba(11,11,11,0.7));
    }

    /* Head */
    #toolbox h2 { font-weight:700; font-size:1rem; }
    #toolbox .back-btn { background:transparent; border:1px solid var(--border); padding:.35rem .5rem; border-radius:8px; font-size:.875rem; }

    /* Inputs */
    .input { width:100%; padding:.6rem .8rem; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--fg); box-sizing:border-box; }
    .input:focus { outline:none; box-shadow:0 8px 18px var(--glass); border-color:var(--accent); }

    /* Reset button */
    .btn-reset { background:#d9534f; color:#fff; padding:.45rem .6rem; border-radius:8px; font-size:0.75rem; border:none; cursor:pointer; }
    .btn-reset:hover { filter:brightness(.95); }

    /* List results */
    #search-results li { padding:.45rem .6rem; border-radius:8px; cursor:pointer; }
    #search-results li:hover { background:var(--krem); }

    /* Layers, Info, Legend panels */
    .panel { background:transparent; border-radius:10px; padding:10px; border:1px solid var(--border); }

    /* Map area */
    #map { flex:1; height:100vh; }

    /* Responsive - mobile-first compact */
    @media (max-width: 900px){
      #toolbox { position:fixed; left:8px; top:8px; bottom:8px; z-index:60; width:84%; max-width:380px; transform:translateX(0); }
      #map { height:100vh; }
    }

    /* Bottom mobile quick bar */
    #mobile-controls { display:none; }
    @media (max-width:900px){
      #mobile-controls { display:flex; gap:8px; position:fixed; bottom:12px; left:12px; right:12px; justify-content:space-between; z-index:70; }
      .mobile-btn { background:var(--card); border:1px solid var(--border); padding:8px 12px; border-radius:999px; box-shadow:0 8px 20px var(--glass); }
    }

    /* Legend small icons */
    .legend-swatch { width:12px; height:12px; border-radius:3px; display:inline-block; margin-right:6px; vertical-align:middle; border:1px solid rgba(0,0,0,0.06); }

    /* Subtle transitions */
    * { transition: background .18s ease, color .18s ease, border-color .18s ease; }
    @media (prefers-reduced-motion: reduce){ *{ transition:none !important } }
  </style>
</head>

<body>
  <!-- Sidebar / Toolbox (kept; features preserved) -->
  <aside id="toolbox" aria-label="Toolbox">
    <div class="flex justify-between items-center">
      <div>
        <h2>Bentala Nusantara</h2>
        <div class="text-sm muted" style="color:var(--muted)">GeoTools</div>
      </div>
      <button id="back-btn" class="back-btn" aria-label="Back to home"><a href="index.html">Back</a></button>
    </div>

    <!-- Search -->
    <div class="glass">
      <label class="text-sm font-semibold">Search</label>
      <input id="search-input" class="input mt-2" type="text" placeholder="Search Subdistrict..." aria-label="Search subdistrict"/>
      <div class="mt-2 flex gap-2">
        <button id="reset-search-btn" class="btn-reset">Reset</button>
        <button id="doSearchBtn" class="input" style="width:auto;padding:.45rem .6rem;background:transparent;border:1px solid var(--border);cursor:pointer;">Cari</button>
      </div>
      <ul id="search-results" class="mt-2 max-h-44 overflow-auto"></ul>
    </div>

    <!-- Layers -->
    <div class="panel">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Layers</div>
        <!-- <div class="muted text-sm">Toggle</div> -->
      </div>
      <div class="mt-3 space-y-2">
        <label class="flex items-center gap-2"><input type="checkbox" id="kepadatan-penduduk-checkbox" /> <span>Population Density</span></label>
        <label class="flex items-center gap-2"><input type="checkbox" id="heatmap-checkbox" /> <span>Heatmap</span></label>
      </div>
    </div>

    <!-- Info -->
    <div class="panel">
      <div class="font-semibold mb-2">Information</div>
      <div id="info-content" class="text-sm muted">Information Not Found</div>
    </div>

    <!-- Legend -->
    <div class="panel">
      <div class="font-semibold mb-2">Legend</div>
      <div id="legend-content" class="text-sm muted">Legenda akan muncul di sini</div>
    </div>
  </aside>

  <!-- Map container -->
  <div id="map" role="region" aria-label="Map preview"></div>

  <!-- Mobile controls -->
  <div id="mobile-controls" class="container">
    <button id="mobile-open" class="mobile-btn"><a href="index.html">Menu</a></button>
    <button id="toggleTheme" class="mobile-btn">Theme</button>
  </div>

  <script>
    // Keep all original features and logic, only cosmetic and performance adjustments done.
    const MAP_SERVICE_KEY = "68da7e8806823ed3f510cc50";
    const DEFAULT_THEME = "basic";

    // Variables preserved
    let map;
    let uniqueKecamatanData = {};
    let highlightLayer = null;
    const vs30PointsLayerId = 'vs30-points';

    // LocalStorage test (preserve behavior)
    try { localStorage.setItem('test','1'); localStorage.removeItem('test'); } catch(e){ console.warn('LocalStorage blocked'); }

    // Initialize Map
    map = new maplibregl.Map({
      container: 'map',
      style: `https://basemap.mapid.io/styles/${DEFAULT_THEME}/style.json?key=${MAP_SERVICE_KEY}`,
      center: [106.82717425766694, -6.175403054116954],
      zoom: 12,
      pitch: 0,
      bearing: 0,
      canvasContextAttributes: { antialias:true },
      attributionControl: true
    });

    // Navigation control
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Fetch GeoJSON and preserve existing processing logic
    fetch('https://geoserver.mapid.io/layers_new/get_layer?api_key=b79dbb1727c346dd953307ca0423d7e0&layer_id=6919aebcf7b37745d822234d&project_id=68ff9caac8804625c64612ff&limit=10000')
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(data => {
        // preserve original union logic
        const kecMap = {};
        data.features.forEach(f => {
          const k = f.properties?.KECAMATAN;
          if(!k) return;
          if(!kecMap[k]) kecMap[k] = [];
          kecMap[k].push(turf.feature(f.geometry, f.properties));
        });

        Object.keys(kecMap).forEach(k => {
          if(kecMap[k].length > 1){
            let union = kecMap[k][0];
            for(let i=1;i<kecMap[k].length;i++) union = turf.union(union, kecMap[k][i]);
            uniqueKecamatanData[k] = turf.feature(union.geometry, {...kecMap[k][0].properties, KECAMATAN:k});
          } else uniqueKecamatanData[k] = kecMap[k][0];
        });

        // points for vs30 preserved
        const pointFeatures = data.features.map(feature => {
          const vs30 = feature.properties?.vs30_avg;
          if(vs30 === undefined || vs30 === null) return null;
          const centroid = turf.center(feature.geometry);
          return turf.feature(centroid.geometry, {...feature.properties, vs30_avg: vs30});
        }).filter(Boolean);

        // Add layers/sources on map load
        map.on('load', ()=> {
          // kepadatan source + layer (preserved)
          map.addSource('kepadatan-src', { type:'geojson', data: data });
          map.addLayer({
            id: 'kepadatan-penduduk',
            type: 'fill',
            source: 'kepadatan-src',
            layout: { 'visibility': 'none' },
            paint: {
              'fill-opacity': 0.5,
              'fill-color': [
                'case',
                ['<=', ['get', 'kepadatan'], 2500], '#FFFFCC',
                ['<=', ['get', 'kepadatan'], 5000], '#FFEE99',
                ['<=', ['get', 'kepadatan'], 10000], '#FFCC66',
                ['<=', ['get', 'kepadatan'], 20000], '#FFAA33',
                '#FF6600'
              ]
            }
          }, 'park');

          // vs30 points source + circle layer
          map.addSource('vs30-points-source', { type:'geojson', data: { type:'FeatureCollection', features: pointFeatures } });
          map.addLayer({
            id: vs30PointsLayerId,
            type:'circle',
            source:'vs30-points-source',
            layout:{ 'visibility':'none' },
            paint:{
              'circle-radius':['interpolate',['linear'],['get','vs30_avg'],0,2,150,4,300,6,500,12],
              'circle-color': ['case',
                ['<=',['get','vs30_avg'],250],'#ff0000',
                ['<=',['get','vs30_avg'],300],'#ff6600',
                ['<=',['get','vs30_avg'],350],'#ffcc00',
                ['<=',['get','vs30_avg'],400],'#66cc00',
                '#006600'
              ],
              'circle-opacity':0.8,
              'circle-stroke-width':1,
              'circle-stroke-color':'#ffffff'
            }
          });

          // heatmap preserved
          map.addLayer({
            id:'vs30-heatmap',
            type:'heatmap',
            source:'vs30-points-source',
            maxzoom:15,
            layout:{ 'visibility':'none' },
            paint:{
              'heatmap-weight':['interpolate',['linear'],['get','vs30_avg'],0,0,200,0.5,500,1],
              'heatmap-intensity':['interpolate',['linear'],['zoom'],0,0.6,15,2],
              'heatmap-color':['interpolate',['linear'],['heatmap-density'],
                0, 'rgba(0,0,255,0)',
                0.2, 'rgb(0,100,200)',
                0.4, 'rgb(0,200,200)',
                0.6, 'rgb(200,200,0)',
                0.8, 'rgb(255,100,0)',
                1, 'rgb(255,0,0)'
              ],
              'heatmap-radius':['interpolate',['linear'],['zoom'],0,30,9,80,15,120],
              'heatmap-opacity':1
            }
          }, 'park');

          // wire checkboxes to visibility (preserved)
          const kepadatanCheckbox = document.getElementById('kepadatan-penduduk-checkbox');
          const heatmapCheckbox = document.getElementById('heatmap-checkbox');

          kepadatanCheckbox.addEventListener('change', function(){ map.setLayoutProperty('kepadatan-penduduk','visibility', this.checked ? 'visible':'none'); updateLegend(); });
          heatmapCheckbox.addEventListener('change', function(){ const v = this.checked ? 'visible':'none'; map.setLayoutProperty(vs30PointsLayerId,'visibility', v); map.setLayoutProperty('vs30-heatmap','visibility', v); updateLegend(); });

          // fit bounds (preserved)
          try {
            const bbox = turf.bbox(data);
            if(Array.isArray(bbox) && bbox.length===4) map.fitBounds(bbox, { padding:50 });
          } catch(e){ console.warn('fitBounds error', e); }

          // connect reset button
          const resetBtn = document.getElementById('reset-search-btn');
          if(resetBtn) resetBtn.addEventListener('click', resetSearch);

        }); // end map.on('load')

        // init search preserved
        initSearch(uniqueKecamatanData);

      }) // end fetch then
      .catch(err => { console.error('Error fetching geojson', err); alert('Terjadi kesalahan saat memuat data peta.'); });

    // Search logic (debounced)
    function initSearch(uniqueData){
      const input = document.getElementById('search-input');
      const results = document.getElementById('search-results');
      const doSearchBtn = document.getElementById('doSearchBtn');
      let tid;
      input.addEventListener('input', (e) => {
        const q = (e.target.value||'').trim().toLowerCase();
        results.innerHTML = '';
        if(tid) clearTimeout(tid);
        if(q.length < 2) return;
        tid = setTimeout(()=> {
          Object.keys(uniqueData).forEach(k => {
            if(k.toLowerCase().includes(q)){
              const li = document.createElement('li');
              li.className = 'rounded';
              li.textContent = k;
              li.addEventListener('click', ()=> { addHighlight(k); input.value = k; results.innerHTML=''; });
              results.appendChild(li);
            }
          });
        }, 200);
      });
      doSearchBtn && doSearchBtn.addEventListener('click', ()=> { input.dispatchEvent(new Event('input')); });
    }

    // addHighlight preserved
    function addHighlight(kecamatan){
      if(!uniqueKecamatanData[kecamatan]) return;
      // remove previous highlight
      if(map.getLayer('highlight-layer')){ try{ map.removeLayer('highlight-layer'); map.removeSource('highlight-source'); }catch(e){} }
      const feature = uniqueKecamatanData[kecamatan];
      map.addSource('highlight-source', { type:'geojson', data: feature });
      map.addLayer({
        id:'highlight-layer',
        type:'fill',
        source:'highlight-source',
        paint:{ 'fill-color':'#005500', 'fill-opacity':0.3, 'fill-outline-color':'#003300' }
      }, 'park');
      // fit to feature
      try{ const bbox = turf.bbox(feature); if(bbox) map.fitBounds(bbox, { padding:50 }); } catch(e){ console.warn(e); }
      displayFeatureInfo(feature);
    }

    // displayFeatureInfo preserved
    function displayFeatureInfo(feature){
      const props = feature.properties || {};
      let lng, lat;
      if(props.longitude && props.latitude){ lng = props.longitude; lat = props.latitude; }
      else { const c = turf.center(feature.geometry); lng = c.geometry.coordinates[0]; lat = c.geometry.coordinates[1]; }
      const kepadatan = props.kepadatan || 'N/A';
      const vs30_avg = props.vs30_avg || 'N/A';
      const infoContent = document.getElementById('info-content');
      infoContent.innerHTML = `<p><strong>Longitude:</strong> ${Number(lng).toFixed(6)}</p>
        <p><strong>Latitude:</strong> ${Number(lat).toFixed(6)}</p>
        <p><strong>Population Density:</strong> ${kepadatan}</p>
        <p><strong>VS30 Average:</strong> ${vs30_avg}</p>`;
    }

    // resetSearch preserved
    function resetSearch(){
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('info-content').innerHTML = 'Information Not Found';
      if(map.getLayer('highlight-layer')){ try{ map.removeLayer('highlight-layer'); map.removeSource('highlight-source'); }catch(e){} }
      map.flyTo({ center:[106.82717425766694, -6.175403054116954], zoom:12 });
    }

    // updateLegend preserved with simpler presentation (keeps same info)
    function updateLegend(){
      const densityChecked = document.getElementById('kepadatan-penduduk-checkbox').checked;
      const heatmapChecked = document.getElementById('heatmap-checkbox').checked;
      const el = document.getElementById('legend-content');
      let html = '';
      if(densityChecked){
        html += `<p><strong>Population Density</strong></p>
          <div class="mt-2"><span class="legend-swatch" style="background:#FFFFCC"></span> Low<br>
          <span class="legend-swatch" style="background:#FFEE99"></span> Medium<br>
          <span class="legend-swatch" style="background:#FFCC66"></span> High<br>
          <span class="legend-swatch" style="background:#FFAA33"></span> Very High</div>`;
      }
      if(heatmapChecked){
        if(html) html += '<hr class="my-2">';
        html += `<p><strong>Heatmap Intensity (vs30)</strong></p>
          <div class="mt-2"><span class="legend-swatch" style="background:#ff0000"></span> vs30 ≤ 250<br>
          <span class="legend-swatch" style="background:#ff6600"></span> 250 < vs30 ≤ 300<br>
          <span class="legend-swatch" style="background:#ffcc00"></span> 300 < vs30 ≤ 350<br>
          <span class="legend-swatch" style="background:#66cc00"></span> 350 < vs30 ≤ 400<br>
          <span class="legend-swatch" style="background:#006600"></span> vs30 > 400</div>`;
      }
      if(!densityChecked && !heatmapChecked) html = 'Layers Not Active';
      el.innerHTML = html;
    }

    // wire legend change (safeguard)
    const kep = document.getElementById('kepadatan-penduduk-checkbox');
    const heat = document.getElementById('heatmap-checkbox');
    kep && kep.addEventListener('change', updateLegend);
    heat && heat.addEventListener('change', updateLegend);
    window.addEventListener('load', updateLegend);

    // Mobile controls: open toolbox when pressing mobile-open
    const mobileOpen = document.getElementById('mobile-open');
    if(mobileOpen){
      mobileOpen.addEventListener('click', ()=> {
        const tb = document.getElementById('toolbox');
        if(tb.style.transform === 'translateX(-110%)'){
          tb.style.transform = '';
        } else {
          tb.style.transform = 'translateX(0)';
        }
      });
    }

    // Theme toggle (mobile)
    const toggleTheme = document.getElementById('toggleTheme');
    toggleTheme && toggleTheme.addEventListener('click', ()=> {
      const cur = document.documentElement.getAttribute('data-theme');
      document.documentElement.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
    });

    // preserve map load log
    map.on('load', ()=> console.log('Peta dimuat dengan sukses!'));

    // Accessibility tweaks
    window.addEventListener('keydown', (e)=> { if(e.key === 'Escape') { document.getElementById('search-input').blur(); } });

  </script>
</body>

</html>

